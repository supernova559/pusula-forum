{% extends "forum/base.html" %}
{% load forum_tags %}

{% block title %}{{ konu.baslik }}{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">

            <!-- 1. Ana Konu Kartı -->
            <div class="card mb-5">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <img src="{% if konu.olusturan.profil and konu.olusturan.profil.foto %}{{ konu.olusturan.profil.foto.url }}{% else %}{% gravatar_url konu.olusturan.email 40 %}{% endif %}" class="me-3 avatar avatar-sm" alt="{{ konu.olusturan.username }}">
                        <div><a class="profil-linki" href="{% url 'forum:profil' konu.olusturan.username %}">{{ konu.olusturan.username }}</a><small class="d-block text-muted">{{ konu.olusturma_tarihi|timesince }} önce</small></div>
                    </div>
                    <div><span class="badge bg-secondary me-2"><i class="fas fa-eye"></i> {{ konu.goruntulenme_sayisi }}</span><a href="{% url 'forum:kategori_detay' konu.kategori.id %}" class="badge bg-primary text-decoration-none">{{ konu.kategori.ad }}</a></div>
                </div>
                <div class="card-body">
                    <h1 class="card-title h2">{{ konu.baslik }}</h1>
                    <p class="card-text fs-5 mb-4">{{ konu.icerik|safe }}</p>
                    <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
    <div>
    {% if user.is_authenticated %}
        <a href="{% url 'forum:konu_begen' konu.pk %}" class="btn {% if user in konu.begenenler.all %}btn-danger{% else %}btn-outline-danger{% endif %} begen-butonu-konu" data-konu-id="{{ konu.pk }}">
            <i class="{% if user in konu.begenenler.all %}fas{% else %}far{% endif %} fa-heart"></i>
            <!-- Sayaç artık butonun içinde -->
            <span class="ms-1" id="begeni-sayaci-konu-{{ konu.pk }}">{{ konu.begenenler.count }}</span>
        </a>
    {% else %}
        <a href="{% url 'forum:login' %}?next={{ request.path }}" class="btn btn-outline-danger disabled" title="Beğenmek için giriş yapmalısınız">
            <i class="far fa-heart"></i>
            <span class="ms-1">{{ konu.begenenler.count }}</span>
        </a>
    {% endif %}
</div>
                        <div class="d-flex align-items-center"><strong class="me-3">Paylaş:</strong><div class="share-buttons-container"><a href="https://twitter.com/intent/tweet?text={{ konu.baslik|urlencode }}&url={{ request.build_absolute_uri }}" target="_blank" class="share-btn btn-twitter" title="X'te Paylaş"><i class="fa-brands fa-x-twitter"></i></a><a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" target="_blank" class="share-btn btn-facebook" title="Facebook'ta Paylaş"><i class="fa-brands fa-facebook-f"></i></a><a href="https://api.whatsapp.com/send?text={{ konu.baslik|urlencode }}%20{{ request.build_absolute_uri }}" target="_blank" class="share-btn btn-whatsapp" title="WhatsApp'ta Paylaş"><i class="fa-brands fa-whatsapp"></i></a><a href="{{ request.build_absolute_uri }}" class="share-btn btn-copy-link" id="copyLinkBtn" title="Linki Kopyala"><i class="fa-solid fa-link"></i></a></div></div>
                    </div>
                </div>
            </div>

            <!-- 2. Cevaplar Bölümü -->
            <h2 class="mb-4 d-flex align-items-center">Cevaplar <span class="badge bg-secondary ms-2">{{ cevaplar_listesi.paginator.count }}</span></h2>
            
            {% for cevap in cevaplar_listesi %}
            <div class="card mb-3" id="cevap-{{ cevap.id }}">
                <div class="card-header d-flex align-items-center">
                    <img src="{% if cevap.yazan.profil and cevap.yazan.profil.foto %}{{ cevap.yazan.profil.foto.url }}{% else %}{% gravatar_url cevap.yazan.email 40 %}{% endif %}" class="me-3 avatar avatar-sm" alt="{{ cevap.yazan.username }}">
                    <div><a class="profil-linki" href="{% url 'forum:profil' cevap.yazan.username %}">{{ cevap.yazan.username }}</a><small class="d-block text-muted">{{ cevap.yazilma_tarihi|timesince }} önce yazdı</small></div>
                </div>
                <div class="card-body">
                    <p class="card-text">{{ cevap.icerik_html|safe }}</p>
                    <div class="mt-3 d-flex align-items-center">
                        {% if user.is_authenticated %}<a href="#" class="btn btn-sm btn-outline-secondary yanitla-butonu" data-cevap-id="{{ cevap.id }}" data-yazan="@{{ cevap.yazan.username }} "><i class="fas fa-reply"></i> Yanıtla</a>{% endif %}
                        <a href="{% url 'forum:begen_cevap' cevap.id %}" class="btn {% if user in cevap.begenenler.all %}btn-danger{% else %}btn-outline-danger{% endif %} btn-sm begen-butonu ms-2" data-cevap-id="{{ cevap.id }}"><i class="{% if user in cevap.begenenler.all %}fas{% else %}far{% endif %} fa-heart"></i> <span class="ms-1" id="begeni-sayaci-cevap-{{ cevap.id }}">{{ cevap.begenenler.count }}</span>
</a>
                    </div>
                </div>
                {% if cevap.yanitlar.all %}
                <div class="card-footer" style="background-color: rgba(50, 50, 70, 0.3);">
                    <a class="d-block text-white text-decoration-none fw-bold" data-bs-toggle="collapse" href="#yanitlar-{{ cevap.id }}" role="button">{{ cevap.yanitlar.all.count }} yanıtı gör/gizle</a>
                    <div class="collapse mt-3" id="yanitlar-{{ cevap.id }}">
                        <!-- YENİ YAPI: Sadece partial şablonu çağırıyoruz -->
                        {% include "forum/partials/yanit_listesi.html" with cevaplar=cevap.yanitlar.all %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% empty %}
            <div class="card p-5 text-center"><p class="mb-0">Bu konuya henüz hiç cevap yazılmamış.</p></div>
            {% endfor %}

            <!-- 3. Sayfalama -->
            {% if cevaplar_listesi.has_other_pages %}<nav aria-label="Sayfa navigasyonu" class="mt-4"><ul class="pagination justify-content-center">{% if cevaplar_listesi.has_previous %}<li class="page-item"><a class="page-link" href="?page={{ cevaplar_listesi.previous_page_number }}">Önceki</a></li>{% else %}<li class="page-item disabled"><span class="page-link">Önceki</span></li>{% endif %}{% for i in cevaplar_listesi.paginator.page_range %}{% if cevaplar_listesi.number == i %}<li class="page-item active"><span class="page-link">{{ i }}</span></li>{% else %}<li class="page-item"><a class="page-link" href="?page={{ i }}</a></li>{% endif %}{% endfor %}{% if cevaplar_listesi.has_next %}<li class="page-item"><a class="page-link" href="?page={{ cevaplar_listesi.next_page_number }}">Sonraki</a></li>{% else %}<li class="page-item disabled"><span class="page-link">Sonraki</span></li>{% endif %}</ul></nav>{% endif %}

            <!-- 4. Cevap Yazma Formu -->
            <div class="card mt-5" id="cevap-formu-alani">
                <div class="card-body"><h5 class="card-title" id="cevap-formu-basligi">Bir Cevap Yaz</h5>{% if user.is_authenticated %}<form method="post">{% csrf_token %}<input type="hidden" name="parent_id" id="parent_id_input" value=""><div class="mb-3"><textarea name="icerik" cols="40" rows="5" class="form-control" placeholder="Cevabınızı buraya yazın..." required id="id_icerik"></textarea></div><button type="submit" class="btn btn-primary">Gönder</button><a href="#" id="yaniti-iptal-et" class="btn btn-secondary d-none ms-2">Yanıtı İptal Et</a></form>{% else %}<p>Cevap ve yanıt yazabilmek için <a href="{% url 'forum:login' %}?next={{ request.path }}">giriş yapmalısınız</a>.</p>{% endif %}</div>
            </div>

            <!-- 5. Geri Dön Butonu -->
            <div class="text-center mt-4"><a href="{% url 'forum:kategori_detay' konu.kategori.id %}" class="btn btn-secondary">« Kategoriye Geri Dön</a></div>

        </div>
    </div>
</div>
{% endblock %}